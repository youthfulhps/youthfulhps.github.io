{"componentChunkName":"component---src-templates-blog-post-js","path":"/react/react-concurrent-mode-01/","result":{"data":{"site":{"siteMetadata":{"title":"Youthfulhps.dev","author":"youthfulhps","siteUrl":"https://youthfulhps.dev","comment":{"disqusShortName":"youthfulhps","utterances":"youthfulhps/youthfulhps.github.io"},"sponsor":{"buyMeACoffeeId":"youthfulhps"}}},"markdownRemark":{"id":"9b83a668-f837-54e1-ae31-4f0f9ffd71ef","excerpt":"리엑트v18에서 동시성 기능을 정식으로 출시하였습니다. 대표적으로,\nAutomatic batching for fewer renders, SSR support for\nSuspense, Fixes for Suspense behavior quirks와 같은 내부적인\n성능 향상과, startTransition, useDeferredValue, SuspenseList…","html":"<p>리엑트v18에서 동시성 기능을 정식으로 출시하였습니다. 대표적으로,\n<em>Automatic batching for fewer renders</em>, <em>SSR support for\nSuspense</em>, <em>Fixes for Suspense behavior quirks</em>와 같은 내부적인\n성능 향상과, <em>startTransition</em>, <em>useDeferredValue</em>, <em>SuspenseList</em>\n과 같은 기능들이 추가되었습니다.</p>\n<p>동시성 기능을 담아내기 위해 리엑트팀은 협력적 멀티테스킹, 우선순위 기반 랜더링,\n스케쥴링, 중단과 같은 메커니즘을 담아냈습니다. 기저에 있는 아키텍처를 수정해야\n했던 만큼 5년이라는 시간동안 많은 시행착오를 겪었을 텐데요.</p>\n<p>이 시리즈는 <em>‘도대체, 동시성이 무엇이길래 리엑트팀에서 5년이라는\n시간을 쏟았으며, 동시성을 위한 메커니즘들의 구현체들이 어떻게 구현되어 있을 까?\n’</em> 라는 호기심에 찾아본 구현체들과 레퍼런스들을 차근차근 정리해보고자 합니다.</p>\n<p>그 첫 번째로, <a href=\"https://deview.kr/2021/sessions/518\">Inside React (동시성을 구현하는 기술)</a>에서 언급한 내용들을 정리하고, 우선순위와 양보 매커니즘이\n어떻게 구현되어 있는 지 살펴보려 합니다.</p>\n<h2 id=\"concurrent-vs-parallelism\" style=\"position:relative;\"><a href=\"#concurrent-vs-parallelism\" aria-label=\"concurrent vs parallelism permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Concurrent vs Parallelism</h2>\n<p>동시성을 설명할 때, 서로 관련있는 병렬성과 함께 설명하곤 합니다.\n하지만, 이 둘은 뚜렷한 차이를 가지고 있으며\nGo 언어의 창시자의 <a href=\"https://go.dev/blog/waza-talk\">Concurrency is not parallelism</a>\n발표 서문에는 다음과 같이 동시성과 병렬성을 비교합니다.</p>\n<p><em>’<strong>동시성은 독립적으로 실행되는 프로세스들의 조합이다.</strong>’\n‘병렬성은 연관된 복수의 연산들을 동시에 실행하는 것이다.’\n’<strong>동시성은 여러 일을 한꺼번에 다루는 문제에 관한 것이다.</strong>’\n‘병렬성은 여러 일을 한꺼번에 실행하는 방법에 관한 것이다.’</em></p>\n<p>아주 멜랑꼴리한데 발표에서 언급한 문구를 빌려 정리하자면,\n<strong>동시성은 프로세서가 하나만 있는 경우, 병렬 처리를 가능케 하지만 병렬처리는 아닙니다.</strong>\n즉, 하나의 스레드로 작업을 순차적으로 처리하지만,\n마치 여러 개의 스레드가 사용되고 있는 것처럼 보이게 하는 것이고,\n동시성은 싱글 코어에서도 동작하지만, 병렬성은 두 개 이상의 코어가 필요합니다.</p>\n<p>병렬성은 예를 들어 GPU를 통해 이미지를 랜더링할 때 R, G, B를 연산하는\n텍스크를 각각의 코어가 작업하는 것과 같이 최소 한 가지 논리적 통제를\n멀티 코어에서 병렬적으로 진행합니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 864px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.333333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAABDklEQVQoz4WT246EIAyGff+n27kxJl55tc66oiConPynJetmouI0aYDSfm1TKLZtAwuvOd0ld/fuUxwNVxJjzPoc7UUy/BmXZUFd13h8PdA0DUIICeacg7U2+WitUVUVyrJE3/f5Cj0FGSmhpgliFJC0N4vFRGcGsu7VruuKYRj+k5yAgZ0ocyRloDQyAbWNmKlqDnwH7mfv/Q1wnhGMISBBjSLgiNkRkOxHIFfIeg+kinzXoRM9WvENIQR+tcMoFcHOQEPJsy1zJq0UPLXXti20mfB8/sD6SJWqFLgHM5AHw5oF8pR1aneC0bQSnCvglYN42nt7LDwovmP4CfjpDd69uct3+OmXXP2Ku5/yAo1jYOU3Q/GkAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Parallel task processing\"\n        title=\"Parallel task processing\"\n        src=\"/static/e2d146e61c5b9a19bb4476de300b308a/9cab2/parallelism-process.png\"\n        srcset=\"/static/e2d146e61c5b9a19bb4476de300b308a/5a46d/parallelism-process.png 300w,\n/static/e2d146e61c5b9a19bb4476de300b308a/0a47e/parallelism-process.png 600w,\n/static/e2d146e61c5b9a19bb4476de300b308a/9cab2/parallelism-process.png 864w\"\n        sizes=\"(max-width: 864px) 100vw, 864px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>반면 동시성은 최소 두 개의 논리적 통제 흐름을 가지고 있으며,\n잘개 쪼개진 두 개 이상의 작업을 지속적으로 컨텍스트 스위칭하여\n마치 동시에 이루어지는 것처럼 보이도록 합니다.\n강의를 듣다가 내용 정리를 위해 일시정지하고 메모하는 것과 같은 작업 처리 방식입니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 864px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 55.99999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABPklEQVQoz4WT226DMAyGef/n603RuotWEy3jsJxIQgj/bG8w2rHVkhUl2J9/O6SY5xlsvP7li+3Fbs/ZiseDPcs5i+/FPsKL7cb7gNPphMPhgMvlgmmaBDSOI2KMEmOtRVmWOB5LdF33C74qnCjJKQVDCf1HD60VhhBlvwVyaU9x71WFwXv5FkKQ4mvLE6mIziFTMgOUUwTUsDGTai8wTlzMtg3O5xcoimnbFk3TCHQFcluREieCGkvuNAUr+DGLii2QpxOcpYI9qcrSHeevM/xSOCNQtUSVm77DrbvKfFo7ioo7IPmgepzfXuks7c8wpQRnDBLJvtU3WFJQ1zXGlEmJEeAyQ75rc62gqXhM6e6m11tmc9SuJqispGoYBmgaPoN44Cn9qDHfsXu/UvHsH3xs6dlZ8eyV7L2K/17KJ+0UX3E77Ee7AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Concurrent task processing\"\n        title=\"Concurrent task processing\"\n        src=\"/static/1c01ef1b6acac66076081b5b3e947f91/9cab2/concurrent-process.png\"\n        srcset=\"/static/1c01ef1b6acac66076081b5b3e947f91/5a46d/concurrent-process.png 300w,\n/static/1c01ef1b6acac66076081b5b3e947f91/0a47e/concurrent-process.png 600w,\n/static/1c01ef1b6acac66076081b5b3e947f91/9cab2/concurrent-process.png 864w\"\n        sizes=\"(max-width: 864px) 100vw, 864px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<h2 id=\"리엑트팀은-왜-동시성-기능을-구현하고자-했을-까\" style=\"position:relative;\"><a href=\"#%EB%A6%AC%EC%97%91%ED%8A%B8%ED%8C%80%EC%9D%80-%EC%99%9C-%EB%8F%99%EC%8B%9C%EC%84%B1-%EA%B8%B0%EB%8A%A5%EC%9D%84-%EA%B5%AC%ED%98%84%ED%95%98%EA%B3%A0%EC%9E%90-%ED%96%88%EC%9D%84-%EA%B9%8C\" aria-label=\"리엑트팀은 왜 동시성 기능을 구현하고자 했을 까 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>리엑트팀은 왜 동시성 기능을 구현하고자 했을 까</h2>\n<p>리엑트는 사용자 인터페이스를 구축하는 라이브러리로서 핵심 역할인 인터렉션에\n대한 업데이트 과정과 사용자 경험에 대한 HCI 연구 결과를 반영하고 궁극적으로\n기술적으로 결합하는 목표를 가지고 있습니다. 사람과 컴퓨터간의 인터렉션에\n대한 연구 결과들을 추상화해서 리엑트 코어의 개선 목표로 삼고 이를\n구현합니다.</p>\n<p>가령, 화면 간 전환에서 로딩 중 상태를 너무 많이 표시하면 UX 품질이\n낮아지는 문제라던지, 빠르게 처리되기를 기대하는 상호작용들과 느려도 문제없는\n상호작용을 구분짓고 이를 적용해서 효과적으로 사용자 인터페이스에 구현할 수 있는\n방법들을 제공하기 위함입니다.</p>\n<p>조금 더 와닿을 수 있게 우리의 구현체들이 동작하는 브라우저 환경에서\n생각해봅시다. 브라우저는 HTML을 파싱하고, 자바스크립트를 실행하며\n랜더트리를 구축하고 그려내는 작업까지 단일 스레드로서 한번에 하나의\n작업만을 수행합니다.</p>\n<p>때문에 메인 스레드가 자바스크립트 엔진에게 실행권을 위임하여\n자바스크립트 파싱을 시작했다면 그 작업을 멈출 수 없으며,\n작업이 완료될 때까지 이후의 작업을 전개할 수 없습니다.\n리엑트 랜더링 연산 과정도 동일한 절차를 거치게 되며,\n이 때 매우 무거운 랜더링 연산 과정이 시작되면 이후의 작업들이 다소\n긴 시간 동안 대기 상태가 되는 블로킹 랜더링이 발생합니다.</p>\n<p>재조정을 위한 리엑트의 비교 알고리즘은 매우 최적화되어 있어\n블로킹되는 이슈가 자주 발생하지 않아 공감하기 어려울 수 있지만,\n<a href=\"https://ajaxlab.github.io/deview2021/blocking\">deview2021/blocking</a>\n데모처럼 입력값에 대한 픽셀 박스를 랜더링하는 연산이 무거워짐에 따라\nkeypress 이벤트에 대한 처리가 지연되고 있음을 경고 플래그를 통해 확인할 수 있습니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1200px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.333333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAACTElEQVQoz1WS23KbSBRF+f9fmoepzFQsc2ua5tJgkGSQZMeWsaILICTFKyeZB0+6atepPnVYvXvTDr/Xx6c+Pv7r9APD3y7nKOfsGSZTMsUF4xcPrlc+v/tzOT8EcP3Bn5K5y3RjXD4xti+MqxeG+Ya+/capXnM+X5lkaJLh/+sXy3k/XdHlmrho0PaRuGyJpKp8iapXRL9UrchXW7oJtmd4PV55PXxqK4zN7kInfWecPng/9Lztj2x3Pbv9QCe1k97++8j7buRtd6L7LvvxQj9cOA03TqeJYTxzPN0YDrIfrgyXG875fKTe5CxEZZMxLxZslnPaxSPZfIG1lqJJabOM2l+wrmMaW5DZmqrOycuKuqgwjym95O507wd0HFBmCfe5S5TG5KnBVQWRiglmLjry8TOfJA7JIoU/M6TGJzIeQRBjZE7fx/T7HuftuCe3OUWuSNMU1yTUekaqE4zVqDBk7ibYoJCc70n9hCBKSJTBxgIzmlhgkefRTyNOf3zDpBqbKAqps9yQFx5rk2MzceBrSqXJvsYkdyEq0b8PKHVJVoX49h6jNbrwOQ57nN1hhxLQv6VHbP+RTDwygSV+SWUzwmSGTnzcICDNxZmdiduEWJXYIsIkC9RDLJF5TIejPJv9HiUAJZYDHRD5dyJNII6zuzsBu3wJ/8I3LkqFeDNFEn0ltZHkJ449ObDyJaJQXsBBrnw6UMsffWoanpcp63VD0T5hmw2r+ZJNW1K/VMwXDzRVzUPxjVW7Zfv8KnVFu1ny3HV0r2tu1ws/Add8Hro2DvjMAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Example of blocking rendering\"\n        title=\"Example of blocking rendering\"\n        src=\"/static/219e96397b3d85a667ab72d28b32c3da/c1b63/blocking-rendering-example.png\"\n        srcset=\"/static/219e96397b3d85a667ab72d28b32c3da/5a46d/blocking-rendering-example.png 300w,\n/static/219e96397b3d85a667ab72d28b32c3da/0a47e/blocking-rendering-example.png 600w,\n/static/219e96397b3d85a667ab72d28b32c3da/c1b63/blocking-rendering-example.png 1200w,\n/static/219e96397b3d85a667ab72d28b32c3da/d8817/blocking-rendering-example.png 1238w\"\n        sizes=\"(max-width: 1200px) 100vw, 1200px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1200px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 43.99999999999999%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAABzUlEQVQoz23QS4sTQRiF4fxOF4JLde9/EAZxp6ILN64CLkRBRAQhDmOc3Bwm104l6e50Ll3VnaruzJhbv1YnIyPRxUdxPoqHU1Xw/IDJdI7r+ojBCCGG9hziemN6jthP3+60SdFSkZiEdOiSCIGx+4XTR41cIsdB9vsUlosAIwU68khjHx32iIMGy3SB8r7ZS+9YTKqocZnp2UvC3idk8YRp8Snh60fMn9xh9uwewYv7jF89oJDEEhPNSOJ85ui5TxS4LBOD9k6JB18w00vMpEHcKWL8EovmG8aNz4SV56j3D9Fv7xJ8eMzk44kF7VMSbZ+hNWmSEkuNmmmurjcoC0t/xEJGxHNFIGwOxkxFl2FzhN9uMqifIqpfcc4rOJW6BdMMk2TkZ7rcEUUZSu5YXmfMpjtmE5tVhgwzRuKQXZHRa25x2nBxDrUytEou7dLoACY5uLTg1Y44sqg6gPPZdj+R3Sm5xRus99kfbui3Vwy6a5q1X1z82NCphnRr4VHDG1CpPw1zcLcHpW3tDTb77A1tu9baghsuq2t+llcWXtOqr/8PRseg+hfst4/B1QE0JkNri5ocvWkob8H8H/cNw539u1tQdP4Cvx/AvOVv0WaXBF6Q6ToAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Delay in processing tasks for keypress\"\n        title=\"Delay in processing tasks for keypress\"\n        src=\"/static/815e3dae1953dd73e6539b5104895244/c1b63/blocking-rendering-performance.png\"\n        srcset=\"/static/815e3dae1953dd73e6539b5104895244/5a46d/blocking-rendering-performance.png 300w,\n/static/815e3dae1953dd73e6539b5104895244/0a47e/blocking-rendering-performance.png 600w,\n/static/815e3dae1953dd73e6539b5104895244/c1b63/blocking-rendering-performance.png 1200w,\n/static/815e3dae1953dd73e6539b5104895244/2eb79/blocking-rendering-performance.png 1256w\"\n        sizes=\"(max-width: 1200px) 100vw, 1200px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>경고 플래그 중 하나의 예시로 keypress 이벤트를 처리하는 데 143.41ms이 소요 되었는데\n<a href=\"https://web.dev/rail/?utm_source=devtools#goals-and-guidelines\">RAIL</a>\n모델을 기반으로 생각한다면, 사용자는 입력 이벤트에 대해 100ms 이상 소요되는 것을\n동작과 응답 사이의 연결이 지연되고 있음을 인식하게 되며, 이는 사용자 경험의 감점으로\n이어질 수 있습니다.</p>\n<p>리엑트는 이러한 사용자 경험에 영향을 끼치는 랜더링 업데이트 과정에서\n동시성을 통해 개선된 인터렉션을 쉽게 구현할 수 있도록 하는 구현체를 제공하고자\n했습니다.</p>\n<h2 id=\"동시성-메커니즘-우선순위\" style=\"position:relative;\"><a href=\"#%EB%8F%99%EC%8B%9C%EC%84%B1-%EB%A9%94%EC%BB%A4%EB%8B%88%EC%A6%98-%EC%9A%B0%EC%84%A0%EC%88%9C%EC%9C%84\" aria-label=\"동시성 메커니즘 우선순위 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>동시성 메커니즘; 우선순위</h2>\n<p>리엑트에서 동시성을 구현하는 첫번 째 메커니즘은 바로 우선순위입니다.</p>\n<p>우선순위 메커니즘은 사용자 인터렉션 발생을 캐치한 리스너에서부터\n업데이트를 위한 작업 생성 과정과 스케쥴링 단계까지 업데이트를 위한\n작업의 우선순위를 할당하기 위한 전반적인 과정에서 쉽게 찾아볼 수 있습니다.</p>\n<p>그 이후 진행 중인 작업이 우선 순위가 높은 대기 상태의 작업에 의해 중단되거나,\n같은 우선 순위를 가진 작업에 대해서 일괄 처리될 수 있도록 하는 작업 교통정리\n를 하는 작업 실행 단계에서도 확인할 수 있는데요.</p>\n<p>한편, 리엑트v17.0 이전에서는 작업의 <a href=\"https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberExpirationTime.js\">만료 시간을 기준으로 우선순위를 부여</a>하는 메커니즘으로 구현되어 있었습니다.\n반면, 리엑트v17.0 이후에서는 Lane 모델을 착안하여 비트 연산을\n기반으로 우선 순위를 부여하는 방식으로 변경되는데요.\n전반적인 우선순위 메커니즘을 담고 있는 모델이기 때문에 우선순위 메커니즘에 대해\n이야기하기 전에 Lane 모델에 대해서 살펴봅시다.</p>\n<h3 id=\"lane-모델-그리고-lane-우선순위\" style=\"position:relative;\"><a href=\"#lane-%EB%AA%A8%EB%8D%B8-%EA%B7%B8%EB%A6%AC%EA%B3%A0-lane-%EC%9A%B0%EC%84%A0%EC%88%9C%EC%9C%84\" aria-label=\"lane 모델 그리고 lane 우선순위 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Lane 모델, 그리고 Lane 우선순위</h3>\n<p>Lane 모델은 도로의 차선을 모티브로 하여 리엑트에서 작업의 우선순위를\n표현하기 위해 사용되었고, 스케쥴링 및 조정 작업 과정에서 매우 중요한 역할을 하는\n개념입니다. 작업을 나타내는 31비트 데이터로 표현된\n비트 마스크를 레인(lane)이라 하고, 고유의 작업 스레드를 표현하고 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// react-reconciler/src/ReactFiberLane.new.js</span>\n\n<span class=\"token keyword\">export</span> type Lanes <span class=\"token operator\">=</span> number<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> type Lane <span class=\"token operator\">=</span> number<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> type LaneMap<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span> Array<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> TotalLanes <span class=\"token operator\">=</span> <span class=\"token number\">31</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token literal-property property\">NoLanes</span><span class=\"token operator\">:</span> Lanes <span class=\"token operator\">=</span> <span class=\"token comment\">/*                        */</span> <span class=\"token number\">0b0000000000000000000000000000000</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token literal-property property\">NoLane</span><span class=\"token operator\">:</span> Lane <span class=\"token operator\">=</span> <span class=\"token comment\">/*                          */</span> <span class=\"token number\">0b0000000000000000000000000000000</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token literal-property property\">SyncLane</span><span class=\"token operator\">:</span> Lane <span class=\"token operator\">=</span> <span class=\"token comment\">/*                        */</span> <span class=\"token number\">0b0000000000000000000000000000001</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token literal-property property\">InputContinuousHydrationLane</span><span class=\"token operator\">:</span> Lane <span class=\"token operator\">=</span> <span class=\"token comment\">/*    */</span> <span class=\"token number\">0b0000000000000000000000000000010</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token literal-property property\">InputContinuousLane</span><span class=\"token operator\">:</span> Lane <span class=\"token operator\">=</span> <span class=\"token comment\">/*             */</span> <span class=\"token number\">0b0000000000000000000000000000100</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token literal-property property\">DefaultHydrationLane</span><span class=\"token operator\">:</span> Lane <span class=\"token operator\">=</span> <span class=\"token comment\">/*            */</span> <span class=\"token number\">0b0000000000000000000000000001000</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token literal-property property\">DefaultLane</span><span class=\"token operator\">:</span> Lane <span class=\"token operator\">=</span> <span class=\"token comment\">/*                     */</span> <span class=\"token number\">0b0000000000000000000000000010000</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token literal-property property\">TransitionHydrationLane</span><span class=\"token operator\">:</span> Lane <span class=\"token operator\">=</span> <span class=\"token comment\">/*                */</span> <span class=\"token number\">0b0000000000000000000000000100000</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token literal-property property\">TransitionLanes</span><span class=\"token operator\">:</span> Lanes <span class=\"token operator\">=</span> <span class=\"token comment\">/*                       */</span> <span class=\"token number\">0b0000000001111111111111111000000</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token literal-property property\">TransitionLane1</span><span class=\"token operator\">:</span> Lane <span class=\"token operator\">=</span> <span class=\"token comment\">/*                        */</span> <span class=\"token number\">0b0000000000000000000000001000000</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">...</span>\n<span class=\"token keyword\">const</span> <span class=\"token literal-property property\">RetryLanes</span><span class=\"token operator\">:</span> Lanes <span class=\"token operator\">=</span> <span class=\"token comment\">/*                            */</span> <span class=\"token number\">0b0000111110000000000000000000000</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token literal-property property\">RetryLane1</span><span class=\"token operator\">:</span> Lane <span class=\"token operator\">=</span> <span class=\"token comment\">/*                             */</span> <span class=\"token number\">0b0000000010000000000000000000000</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">...</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token literal-property property\">SomeRetryLane</span><span class=\"token operator\">:</span> Lane <span class=\"token operator\">=</span> RetryLane1<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token literal-property property\">SelectiveHydrationLane</span><span class=\"token operator\">:</span> Lane <span class=\"token operator\">=</span> <span class=\"token comment\">/*          */</span> <span class=\"token number\">0b0001000000000000000000000000000</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> <span class=\"token literal-property property\">NonIdleLanes</span><span class=\"token operator\">:</span> Lanes <span class=\"token operator\">=</span> <span class=\"token comment\">/*                          */</span> <span class=\"token number\">0b0001111111111111111111111111111</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token literal-property property\">IdleHydrationLane</span><span class=\"token operator\">:</span> Lane <span class=\"token operator\">=</span> <span class=\"token comment\">/*               */</span> <span class=\"token number\">0b0010000000000000000000000000000</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token literal-property property\">IdleLane</span><span class=\"token operator\">:</span> Lane <span class=\"token operator\">=</span> <span class=\"token comment\">/*                        */</span> <span class=\"token number\">0b0100000000000000000000000000000</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token literal-property property\">OffscreenLane</span><span class=\"token operator\">:</span> Lane <span class=\"token operator\">=</span> <span class=\"token comment\">/*                   */</span> <span class=\"token number\">0b1000000000000000000000000000000</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Lane 모델은 우선순위를 두 가지 중요한 컨셉으로 분리합니다.</p>\n<ul>\n<li><em>Task Prioritization, A 작업이 B 작업보다 급한가?</em></li>\n<li><em>Task Batching, A 작업이 이 그룹 텍스크에 속하는 가?</em></li>\n</ul>\n<p>작업 우선순위 개념을 통해 작업의 우선순위를 기준으로 작업의\n우선 실행권을 부여하고, 작업 배칭 개념을 착안하여\n가령 CPU, I/O, CPU 순의 작업 예약에 대해,\nI/O 작업을 다른 그룹으로 분리하여 일괄 처리함으로서 CPU 작업의 병목을\n방지할 수 있도록 합니다.</p>\n<p><em>CPU 작업이 I/O 작업보다 우선순위가 낮아 지속적인 양보가 발생하게 되면 CPU 작업처리에\n진전이 없을 여지를 방지하기 위해 I/O 작업들을 묶어 진행할 수 있도록 하는 것은\n리엑트v18에서 제공하는 <a href=\"https://github.com/reactwg/react-18/discussions/21\">Automatic Batching</a>\n의 기저에 있는 동작 방식인듯 합니다. 깊이 있게 살펴볼 부분들이 차고 넘치네요.</em></p>\n<p>Task Prioritization이 표현되는 각각의 레인이 가지고 있는\n비트 값이 우선순위를 나타내고 있으며, 레인의 이름을 통해\n어떠한 업데이트가 소유할 수 있는 레인인지 파악해볼 수 있습니다.</p>\n<ul>\n<li><em><strong>SyncLane</strong>, 이산적인(discrete) 사용자 상호 작용에 대한 업데이트</em></li>\n<li><em><strong>InputContinuousLane</strong>, 연속적인(continuous) 사용자 상호 작용에 대한 업데이트</em></li>\n<li><em><strong>DefaultLane</strong>, setTimeout, 네트워크 요청 등에 의해 생성된 업데이트</em></li>\n<li><em><strong>TransitionLane</strong>, Suspense, useTransition, useDefferredValue에 의해 생성된 업데이트</em></li>\n</ul>\n<p>레인 모델이 어떻게 구현되어 있는 지 간단하게 살펴보았다면,\n어떻게 적용되어 사용되는 지 확인해볼 차례입니다.\n리엑트에서 Lane 모델을 기반으로 Lane 우선순위 개념을 이벤트 우선순위와\n스케쥴러 우선순위에 녹여냈는 지 살펴봅시다.</p>\n<p><em>Lane 모델에 대한 설명은 <a href=\"https://tv.naver.com/v/23652451\">deview2021/Inside React (동시성을 구현하는 기술)</a>\n과 초기 레인 모델을 구현한 <a href=\"https://github.com/facebook/react/pull/18796\">react/pull/18796</a>\nPR을 기반으로 작성하였습니다. 추가적인 내용은 레퍼런스를 참고하시면 좋습니다.</em></p>\n<h3 id=\"이벤트-우선순위\" style=\"position:relative;\"><a href=\"#%EC%9D%B4%EB%B2%A4%ED%8A%B8-%EC%9A%B0%EC%84%A0%EC%88%9C%EC%9C%84\" aria-label=\"이벤트 우선순위 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>이벤트 우선순위</h3>\n<p>리엑트는 사용자 인터렉션에 의해 발생된 이벤트를 인위적으로 구분짓고,\n구분된 이벤트를 묶어 우선순위를 결정짓습니다.\n여기서, 크게 두 종요로 구분되어 루트에 바인딩될 때 어느 범주에 속한\n이벤트인지에 따라 우선순위가 부여됩니다.</p>\n<ul>\n<li><em>이산적인 이벤트 (e.g. click, keydown, focusin, ..)</em></li>\n<li><em>연속적인 이벤트 (e.g. drag, pointermove, scroll, ..)</em></li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// react-reconciler/src/ReactEventPriority.new.js</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token literal-property property\">DiscreteEventPriority</span><span class=\"token operator\">:</span> EventPriority <span class=\"token operator\">=</span> SyncLane<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token literal-property property\">ContinuousEventPriority</span><span class=\"token operator\">:</span> EventPriority <span class=\"token operator\">=</span> InputContinuousLane<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token literal-property property\">DefaultEventPriority</span><span class=\"token operator\">:</span> EventPriority <span class=\"token operator\">=</span> DefaultLane<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token literal-property property\">IdleEventPriority</span><span class=\"token operator\">:</span> EventPriority <span class=\"token operator\">=</span> IdleLane<span class=\"token punctuation\">;</span></code></pre></div>\n<p>여기서, 이벤트 우선순위에 할당되는 값들은 앞서 살펴보았던 31비트로 구성되어 있는 Lane들과\n매핑되어 있는 것을 확인하실 수 있습니다.</p>\n<p>그리고 각각의 이벤트에 대해 우선순위를 반환하는 함수가 작성되어 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// react-dom/src/events/ReactDOMEventListener.js</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getEventPriority</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token literal-property property\">domEventName</span><span class=\"token operator\">:</span> DOMEventName</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>domEventName<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">case</span> <span class=\"token string\">'cancel'</span><span class=\"token operator\">:</span>\n    <span class=\"token keyword\">case</span> <span class=\"token string\">'click'</span><span class=\"token operator\">:</span>\n    <span class=\"token keyword\">case</span> <span class=\"token string\">'close'</span><span class=\"token operator\">:</span>\n    <span class=\"token keyword\">case</span> <span class=\"token string\">'contextmenu'</span><span class=\"token operator\">:</span>\n    <span class=\"token operator\">...</span>\n      <span class=\"token keyword\">return</span> DiscreteEventPriority<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">case</span> <span class=\"token string\">'drag'</span><span class=\"token operator\">:</span>\n    <span class=\"token keyword\">case</span> <span class=\"token string\">'dragenter'</span><span class=\"token operator\">:</span>\n    <span class=\"token keyword\">case</span> <span class=\"token string\">'dragexit'</span><span class=\"token operator\">:</span>\n    <span class=\"token keyword\">case</span> <span class=\"token string\">'dragleave'</span><span class=\"token operator\">:</span>\n    <span class=\"token operator\">...</span>\n      <span class=\"token keyword\">return</span> ContinuousEventPriority<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">case</span> <span class=\"token string\">'message'</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> schedulerPriority <span class=\"token operator\">=</span> <span class=\"token function\">getCurrentSchedulerPriorityLevel</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>schedulerPriority<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">case</span> <span class=\"token literal-property property\">ImmediateSchedulerPriority</span><span class=\"token operator\">:</span>\n          <span class=\"token keyword\">return</span> DiscreteEventPriority<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">case</span> <span class=\"token literal-property property\">UserBlockingSchedulerPriority</span><span class=\"token operator\">:</span>\n          <span class=\"token keyword\">return</span> ContinuousEventPriority<span class=\"token punctuation\">;</span>\n        <span class=\"token operator\">...</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">default</span><span class=\"token operator\">:</span>\n      <span class=\"token keyword\">return</span> DefaultEventPriority<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><em>여기서 ‘message’ 이벤트는 따로 처리해주는 것을 확인할 수 있는데, 협력적 스케쥴링 모델을\n사용하고, 정확한 스케쥴링 타임을 위해 리엑트 스케쥴러에서는 MessageChannel API를 기반으로\n구현되어 있습니다. 따라서 ‘message’ 이벤트가 스케쥴러 콜백일 수 있기 때문에\n‘message’ 이벤트에 대해서는 네이티브 스케쥴러에 대한 현재 우선 순위를 확인하여 반환합니다.</em></p>\n<p><code class=\"language-text\">getEventPriority()</code> 를 따라 올라가다 보면, 대응되는 이벤트 우선순위를\n각각의 이벤트 리스너에 래핑시키고, 우선순위가 래핑된 이벤트 리스너를 반환하는 곳에서\n사용됩니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// react-dom/src/events/ReactDOMEventListener.js</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">createEventListenerWrapperWithPriority</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\"><span class=\"token literal-property property\">targetContainer</span><span class=\"token operator\">:</span> EventTarget<span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">domEventName</span><span class=\"token operator\">:</span> DOMEventName<span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">eventSystemFlags</span><span class=\"token operator\">:</span> EventSystemFlags</span>\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Function <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> eventPriority <span class=\"token operator\">=</span> <span class=\"token function\">getEventPriority</span><span class=\"token punctuation\">(</span>domEventName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> listenerWrapper<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">switch</span> <span class=\"token punctuation\">(</span>eventPriority<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">case</span> <span class=\"token literal-property property\">DiscreteEventPriority</span><span class=\"token operator\">:</span>\n      listenerWrapper <span class=\"token operator\">=</span> dispatchDiscreteEvent<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">case</span> <span class=\"token literal-property property\">ContinuousEventPriority</span><span class=\"token operator\">:</span>\n      listenerWrapper <span class=\"token operator\">=</span> dispatchContinuousEvent<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">case</span> <span class=\"token literal-property property\">DefaultEventPriority</span><span class=\"token operator\">:</span>\n    <span class=\"token keyword\">default</span><span class=\"token operator\">:</span>\n      listenerWrapper <span class=\"token operator\">=</span> dispatchEvent<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">listenerWrapper</span><span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span>\n    <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n    domEventName<span class=\"token punctuation\">,</span>\n    eventSystemFlags<span class=\"token punctuation\">,</span>\n    targetContainer\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>결국 <code class=\"language-text\">createRoot()</code> 에서\n리엑트17 이후 버전의 <a href=\"https://ko.reactjs.org/blog/2020/08/10/react-v17-rc.html#changes-to-event-delegation\">이벤트 위임 메커니즘</a>\n에 입각하여, 우선 순위가 래핑된 이벤트 리스너들이 모두 루트에 바인딩되게 됩니다.</p>\n<p>이를 통해 사용자 상호 인터렉션에 따라 발생한 이벤트 우선순위는,\n바인딩된 이벤트 리스너를 통해 주입받을 수 있게 됩니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// react-dom/src/client/ReactDOMRoot.js</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">createRoot</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\"><span class=\"token literal-property property\">container</span><span class=\"token operator\">:</span> Element <span class=\"token operator\">|</span> Document <span class=\"token operator\">|</span> DocumentFragment<span class=\"token punctuation\">,</span>\n  options<span class=\"token operator\">?</span><span class=\"token operator\">:</span> CreateRootOptions<span class=\"token punctuation\">,</span></span>\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> RootType <span class=\"token punctuation\">{</span>\n  <span class=\"token operator\">...</span>\n  <span class=\"token keyword\">const</span> root <span class=\"token operator\">=</span> <span class=\"token function\">createContainer</span><span class=\"token punctuation\">(</span>\n    <span class=\"token operator\">...</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">markContainerAsRoot</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">,</span> container<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> <span class=\"token literal-property property\">rootContainerElement</span><span class=\"token operator\">:</span> Document <span class=\"token operator\">|</span> Element <span class=\"token operator\">|</span> DocumentFragment <span class=\"token operator\">=</span>\n    container<span class=\"token punctuation\">.</span>nodeType <span class=\"token operator\">===</span> <span class=\"token constant\">COMMENT_NODE</span>\n      <span class=\"token operator\">?</span> <span class=\"token punctuation\">(</span>container<span class=\"token punctuation\">.</span>parentNode<span class=\"token operator\">:</span> any<span class=\"token punctuation\">)</span>\n      <span class=\"token operator\">:</span> container<span class=\"token punctuation\">;</span>\n  <span class=\"token function\">listenToAllSupportedEvents</span><span class=\"token punctuation\">(</span>rootContainerElement<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">//**</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">ReactDOMRoot</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"스케쥴링-우선순위\" style=\"position:relative;\"><a href=\"#%EC%8A%A4%EC%BC%80%EC%A5%B4%EB%A7%81-%EC%9A%B0%EC%84%A0%EC%88%9C%EC%9C%84\" aria-label=\"스케쥴링 우선순위 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>스케쥴링 우선순위</h3>\n<p>스케쥴링 우선순위는 스케쥴러 기반의 리엑트 업데이트 작업이 가지는\n우선순위입니다. 스케쥴러는 스케쥴링 우선순위를 통해 산발적으로\n발생하는 작업들의 교통정리를 진행합니다.</p>\n<p>리콘실러는 스케쥴러에게 작업을 전달하기 전에 작업의 우선순위 정보를 포함시켜\n전달하게 되는데,\n가령 이벤트가 발생하여 setState를 통해 부가적인 상태 업데이트가\n디스패치되면, 업데이트를 위한 객체를 생성하기 이전 <code class=\"language-text\">requestUpdateLane()</code>\n이 호출됩니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// react-reconciler/src/ReactFiberHooks.new.js</span>\n\n<span class=\"token keyword\">function</span> dispatchSetState<span class=\"token operator\">&lt;</span><span class=\"token constant\">S</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">A</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>\n  <span class=\"token literal-property property\">fiber</span><span class=\"token operator\">:</span> Fiber<span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">queue</span><span class=\"token operator\">:</span> UpdateQueue<span class=\"token operator\">&lt;</span><span class=\"token constant\">S</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">A</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\n  <span class=\"token literal-property property\">action</span><span class=\"token operator\">:</span> <span class=\"token constant\">A</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token operator\">...</span>\n\n  <span class=\"token keyword\">const</span> lane <span class=\"token operator\">=</span> <span class=\"token function\">requestUpdateLane</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> <span class=\"token literal-property property\">update</span><span class=\"token operator\">:</span> Update<span class=\"token operator\">&lt;</span><span class=\"token constant\">S</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">A</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    lane<span class=\"token punctuation\">,</span>\n    action<span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">hasEagerState</span><span class=\"token operator\">:</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">eagerState</span><span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">next</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token operator\">:</span> any<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token operator\">...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>업데이트 객체에 전달되는 우선순위를 구하는 <code class=\"language-text\">requestUpdateLane()</code>\n는 어떻게 이벤트 우선순위를 얻어오는 지 살펴봅시다.</p>\n<p>먼저 현재 랜더링 모드에 대해 판단하여 동시성 기능을 제공하는 모드가\n아니라면, SyncLane을 반환합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">requestUpdateLane</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token literal-property property\">fiber</span><span class=\"token operator\">:</span> Fiber</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Lane <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> mode <span class=\"token operator\">=</span> fiber<span class=\"token punctuation\">.</span>mode<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>mode <span class=\"token operator\">&amp;</span> ConcurrentMode<span class=\"token punctuation\">)</span> <span class=\"token operator\">===</span> NoMode<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>SyncLane<span class=\"token operator\">:</span> Lane<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token operator\">...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>만약, 동시성 기능을 제공하는 모드에서 작업 중이라면, 먼저 현재 실행 중인\n작업이 있는 지 확인합니다. 만약 있다면, 현재 실행 중인 작업의 레인이\n직접 반환되고, 새 작업이 기존 작업과 같은 우선순위를 부여받아 현재 작업과\n함께 업데이트됩니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">let</span> <span class=\"token literal-property property\">workInProgressRootRenderLanes</span><span class=\"token operator\">:</span> Lanes <span class=\"token operator\">=</span> NoLanes<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">requestUpdateLane</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token literal-property property\">fiber</span><span class=\"token operator\">:</span> Fiber</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Lane <span class=\"token punctuation\">{</span>\n  <span class=\"token operator\">...</span>\n  <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token operator\">!</span>deferRenderPhaseUpdateToNextBatch <span class=\"token operator\">&amp;&amp;</span>\n    <span class=\"token punctuation\">(</span>executionContext <span class=\"token operator\">&amp;</span> RenderContext<span class=\"token punctuation\">)</span> <span class=\"token operator\">!==</span> NoContext <span class=\"token operator\">&amp;&amp;</span>\n    workInProgressRootRenderLanes <span class=\"token operator\">!==</span> NoLanes\n  <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token function\">pickArbitraryLane</span><span class=\"token punctuation\">(</span>workInProgressRootRenderLanes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token operator\">...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// react-reconciler/src/ReactFiberLane.new.js</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getHighestPriorityLane</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token literal-property property\">lanes</span><span class=\"token operator\">:</span> Lanes</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Lane <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> lanes <span class=\"token operator\">&amp;</span> <span class=\"token operator\">-</span>lanes<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">pickArbitraryLane</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token literal-property property\">lanes</span><span class=\"token operator\">:</span> Lanes</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Lane <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">getHighestPriorityLane</span><span class=\"token punctuation\">(</span>lanes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>위 조건에서 걸러지지 않았다면, 이제 현재 이벤트가 Transition(전환) 우선\n순위인지 여부를 결정하고 맞다면 적절한 전환 우선순위에 할당하게 됩니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">let</span> <span class=\"token literal-property property\">currentEventTransitionLane</span><span class=\"token operator\">:</span> Lanes <span class=\"token operator\">=</span> NoLanes<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">requestUpdateLane</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token literal-property property\">fiber</span><span class=\"token operator\">:</span> Fiber</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Lane <span class=\"token punctuation\">{</span>\n  <span class=\"token operator\">...</span>\n  <span class=\"token keyword\">const</span> isTransition <span class=\"token operator\">=</span> <span class=\"token function\">requestCurrentTransition</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!==</span> NoTransition<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isTransition<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>__DEV__ <span class=\"token operator\">&amp;&amp;</span> ReactCurrentBatchConfig<span class=\"token punctuation\">.</span>transition <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> transition <span class=\"token operator\">=</span> ReactCurrentBatchConfig<span class=\"token punctuation\">.</span>transition<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>transition<span class=\"token punctuation\">.</span>_updatedFibers<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        transition<span class=\"token punctuation\">.</span>_updatedFibers <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Set</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n\n      transition<span class=\"token punctuation\">.</span>_updatedFibers<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>currentEventTransitionLane <span class=\"token operator\">===</span> NoLane<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      currentEventTransitionLane <span class=\"token operator\">=</span> <span class=\"token function\">claimNextTransitionLane</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> currentEventTransitionLane<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// react-reconciler/src/ReactFiberLane.new.js</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">claimNextTransitionLane</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Lane <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> lane <span class=\"token operator\">=</span> nextTransitionLane<span class=\"token punctuation\">;</span>\n  nextTransitionLane <span class=\"token operator\">&lt;&lt;=</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>nextTransitionLane <span class=\"token operator\">&amp;</span> TransitionLanes<span class=\"token punctuation\">)</span> <span class=\"token operator\">===</span> NoLanes<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    nextTransitionLane <span class=\"token operator\">=</span> TransitionLane1<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> lane<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이 때, 생성된 작업에 대해 맨 오른쪽 비트를 소유하는 TransitionLane을\n할당하고, 후속으로 생성된 작업에 대해 왼쪽으로 한 자리 이동된 비트를 소유하는\nTransitionLane을 할당합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">TransitionLane1 <span class=\"token operator\">=</span> <span class=\"token number\">0b0000000000000000000000001000000</span><span class=\"token punctuation\">;</span>\nTransitionLane2 <span class=\"token operator\">=</span> <span class=\"token number\">0b0000000000000000000000010000000</span><span class=\"token punctuation\">;</span>\n<span class=\"token operator\">...</span>\n\nTransitionLanes <span class=\"token operator\">=</span> <span class=\"token number\">0b0000000001111111111111111000000</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>전환 우선순위 작업이 아닌 경우에는 어떻게 처리될까요? 이벤트 우선순위 섹션에서\n우선순위가 래핑된 이벤트 리스너가 모두 루트에 바인딩되는 걸 확인했었는데요.\n여기서 이벤트가 발생하면 <code class=\"language-text\">setCurrentUpdatePriority()</code>가 호출되어\n현재 이벤트 우선순위를 반환되어 스케쥴링 우선순위로 사용됩니다.</p>\n<p>만약 현재 이벤트 우선순위가 비어있다면, <code class=\"language-text\">getCurrentUpdatePriority()</code>\n에서 외부 이벤트의 우선순위를 가져옵니다. 이런 케이스는 가령, setState가\nsetTimeout에서 호출된 케이스입니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">requestUpdateLane</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token literal-property property\">fiber</span><span class=\"token operator\">:</span> Fiber</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Lane <span class=\"token punctuation\">{</span>\n  <span class=\"token operator\">...</span>\n  <span class=\"token keyword\">const</span> <span class=\"token literal-property property\">updateLane</span><span class=\"token operator\">:</span> Lane <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token function\">getCurrentUpdatePriority</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> any<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>updateLane <span class=\"token operator\">!==</span> NoLane<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> updateLane<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">const</span> <span class=\"token literal-property property\">eventLane</span><span class=\"token operator\">:</span> Lane <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token function\">getCurrentEventPriority</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> any<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> eventLane<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이벤트의 우선순위를 얻은 다음, Lane을 사용하면 어떻게 되는 지 알아봅시다.\n업데이트 객체가 생성되고, 이벤트의 레인이 업데이트 객체에 추가됩니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">createUpdate</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token literal-property property\">eventTime</span><span class=\"token operator\">:</span> number<span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">lane</span><span class=\"token operator\">:</span> Lane</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Update<span class=\"token operator\">&lt;</span><span class=\"token operator\">*</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token literal-property property\">update</span><span class=\"token operator\">:</span> Update<span class=\"token operator\">&lt;</span><span class=\"token operator\">*</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    eventTime<span class=\"token punctuation\">,</span>\n    lane<span class=\"token punctuation\">,</span>\n\n    <span class=\"token literal-property property\">tag</span><span class=\"token operator\">:</span> UpdateState<span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">payload</span><span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">callback</span><span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n\n    <span class=\"token literal-property property\">next</span><span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> update<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>다음으로 업데이트해야 하는 컨텐츠를 페이로드에 담고,\n업데이트 콜백 함수를 업데이트 객체의 콜백 속성에 담습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">update<span class=\"token punctuation\">.</span>payload <span class=\"token operator\">=</span> payload<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>callback <span class=\"token operator\">!==</span> <span class=\"token keyword\">undefined</span> <span class=\"token operator\">&amp;&amp;</span> callback <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  update<span class=\"token punctuation\">.</span>callback <span class=\"token operator\">=</span> callback<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>그 다음 현재 컴포넌트에 해당하는 FiberNode의 업데이트 대기열에\n업데이트 객체가 추가됩니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function\">enqueueUpdate</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">,</span> update<span class=\"token punctuation\">,</span> lane<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>그 이후 스케쥴러 작업을 위해 설정된 우선순위가 사용되게 됩니다.\n사용단계는 다음에 살펴봅시다.</p>\n<h2 id=\"작업의-중단과-스레드-양보는-어떻게-이루어-질-까\" style=\"position:relative;\"><a href=\"#%EC%9E%91%EC%97%85%EC%9D%98-%EC%A4%91%EB%8B%A8%EA%B3%BC-%EC%8A%A4%EB%A0%88%EB%93%9C-%EC%96%91%EB%B3%B4%EB%8A%94-%EC%96%B4%EB%96%BB%EA%B2%8C-%EC%9D%B4%EB%A3%A8%EC%96%B4-%EC%A7%88-%EA%B9%8C\" aria-label=\"작업의 중단과 스레드 양보는 어떻게 이루어 질 까 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>작업의 중단과 스레드 양보는 어떻게 이루어 질 까</h2>\n<p>브라우저는 랜더링 엔진에게 메인 스레드 점유를 위임하게 되면,\n랜더링 과정 중 발생한 사용자 입력에 대해 즉시 처리할 수 없게 됩니다.\n리엑트는 이러한 근본적인 원인을 해결하고자 <strong>모든 랜더링을 인터럽트 가능하도록 하여\n우선순위가 높은 작업이 텍스크 스택에 들어오면 진행중이던 작업을 중단하고 메인 스레드에게\n점유를 양보(yield)할 수 있는 메커니즘을 구현하게 됩니다.</strong></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1200px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.333333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA1UlEQVQoz42S6wqDMAyF+/5PuMl+uckG1mpbe/F6ZgtK0VY9UAJJ+DhJSrDTPM9bDF9Yj9XWSO5AwlpMYZ7Ekk7TNCHLMjyeT+R5vvUMDUNb/lDVNRhjGMfx3GHXdej7Hv0wwLQtaPFBxWqfm5a6tALSSAghoJQ6uCd7d67JWuuBWkiU3xyMNzDaeNexcQ8jhw6llNBawy5OVcNRvF+gbszF7QqMHeTyKE5ufK44uOA46wt1CnSurLF+X/u+lMjZThyQUgpjzSUoCUx9ozuwJDC1gjvQP0YgZVDyZo+xAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"When the user&#39;s input comes in, rendering is interrupted\"\n        title=\"When the user&#39;s input comes in, rendering is interrupted\"\n        src=\"/static/e2ceddd26691f38b0dec421c08a40c58/c1b63/interruption-and-yield.png\"\n        srcset=\"/static/e2ceddd26691f38b0dec421c08a40c58/5a46d/interruption-and-yield.png 300w,\n/static/e2ceddd26691f38b0dec421c08a40c58/0a47e/interruption-and-yield.png 600w,\n/static/e2ceddd26691f38b0dec421c08a40c58/c1b63/interruption-and-yield.png 1200w,\n/static/e2ceddd26691f38b0dec421c08a40c58/d61c2/interruption-and-yield.png 1800w,\n/static/e2ceddd26691f38b0dec421c08a40c58/97a96/interruption-and-yield.png 2400w,\n/static/e2ceddd26691f38b0dec421c08a40c58/5fe07/interruption-and-yield.png 3422w\"\n        sizes=\"(max-width: 1200px) 100vw, 1200px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>페이스북팀은 <strong>메인 스레드를 점유하여 랜더링 연산을 전개하고 있는 과정에서\n사용자의 입력에 대한 처리가 대기 중임을 확인하고 메인 스레드 점유를\n양보해야 하는 지에 대해 판단을 할 수 있어야 했고, 이에 대한 메커니즘을\n담은 구현체인 <a href=\"https://wicg.github.io/is-input-pending/\">isInputPending</a>\n브라우저 API를 기여하게 됩니다.</strong></p>\n<p>실제로 리엑트의 <a href=\"https://github.com/facebook/react/blob/main/packages/scheduler/src/forks/Scheduler.js\">Scheduler</a>(스케쥴러) 패키지 코드에는\n호스트 환경에 의존적인 API를 사용 가능한지에 대한 플래그들이 존재하고,\n어떠한 기준으로 메인 스레드에게 점유를 양보할 것인지에 대한 전개가 담겨있습니다.</p>\n<h3 id=\"shouldyieldtohost\" style=\"position:relative;\"><a href=\"#shouldyieldtohost\" aria-label=\"shouldyieldtohost permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>shouldYieldToHost</h3>\n<p>양보가 필요한 상황인지를 판단하기 위한 첫 검증은 현재 작업을\n처리하기 위해 얼마만큼의 시간을 소요했는 지를 확인합니다.\n경과된 시간이 frameInterval 값보다 작다면,\n메인 스레드는 단일 프레임만큼 아주 짧은 시간동안만 차단되어 있었기 때문에\n양보하지 않습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// SchedulerFeatureFlags.js</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> frameYieldMs <span class=\"token operator\">=</span> <span class=\"token number\">5</span><span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> frameYieldMs <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'../SchedulerFeatureFlags'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">let</span> frameInterval <span class=\"token operator\">=</span> frameYieldMs<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">shouldYieldToHost</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> timeElapsed <span class=\"token operator\">=</span> <span class=\"token function\">getCurrentTime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> startTime<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>timeElapsed <span class=\"token operator\">&lt;</span> frameInterval<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token operator\">...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이후의 스코프에서는 메인 스레드가 무시할 수 없는 시간 동안 차단되었을 때\n보류 중인 페인트 혹은 사용자 입력 작업이 존재한다면,\n브라우저가 높은 우선 순위 작업을 수행할 수 있도록 메인 스레드에\n대한 제안 권한을 양보합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">let</span> needsPaint <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">requestPaint</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n    enableIsInputPending <span class=\"token operator\">&amp;&amp;</span>\n    navigator <span class=\"token operator\">!==</span> <span class=\"token keyword\">undefined</span> <span class=\"token operator\">&amp;&amp;</span>\n    navigator<span class=\"token punctuation\">.</span>scheduling <span class=\"token operator\">!==</span> <span class=\"token keyword\">undefined</span> <span class=\"token operator\">&amp;&amp;</span>\n    navigator<span class=\"token punctuation\">.</span>scheduling<span class=\"token punctuation\">.</span>isInputPending <span class=\"token operator\">!==</span> <span class=\"token keyword\">undefined</span>\n  <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    needsPaint <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">shouldYieldToHost</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token operator\">...</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>enableIsInputPending<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>needsPaint<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token operator\">...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>여기서, requestPaints()를 호출하는 곳 중 하나인 reconciler(리콘실러)는\n<strong>VDOM의 변경사항을 DOM에 모두 커밋하고 나서 requestPaints() 를 통해\n페인트 작업이 필요하다는 것을 스케쥴러에게 전달하게 됩니다.</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// ReactFiberWorkLoop.new.js</span>\n\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> requestPaint <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./Scheduler'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">commitRootImpl</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token operator\">...</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token operator\">...</span>\n  <span class=\"token function\">requestPaint</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>다음으로는 경과된 시간이 연속적인 입력 간격보다 짧은 지 검증합니다.\nisInputPending은 단순히 모든 사용자 이벤트를 동일하게 처리하지 않고,\n<a href=\"%5B%EC%97%B0%EC%86%8D%EC%A0%81%EC%9D%B8%20%EC%9D%B4%EB%B2%A4%ED%8A%B8(Continuous%20events)%5D(https://wicg.github.io/is-input-pending/#continuous-events)\">연속적인(continuous) 이벤트</a>(e.g. click)와 분리된(discrete) 이벤트(e.g. mouseover)를 구분지어 <strong>연속적인 이벤트에 대해 너무 자주 양보하게 되는 것을 막습니다.</strong></p>\n<p>가령 문서를 읽을 때, 시선의 흐름을 마우스 포인터의 이동으로 따라가는 것이\n일반적으로 사용자에게 성능에 대한 영향을 주지 않을 것으로 예상하기 때문에\n기본적으로 이러한 이벤트들은 isInputPending의 검증 대상에서 제외됩니다.</p>\n<p>즉 이 검증 단계에서는, 연속적인 이벤트에 대한 처리 작업을 즉시 시작하지 않을 간격을 두고,\n그 시간 동안에는 판단을 온전히 브라우저에게 맡깁니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// SchedulerFeatureFlags.js</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> continuousYieldMs <span class=\"token operator\">=</span> <span class=\"token number\">50</span><span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> continuousYieldMs <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'../SchedulerFeatureFlags'</span>\n\n<span class=\"token keyword\">const</span> continuousInputInterval <span class=\"token operator\">=</span> continuousYieldMs<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> isInputPending <span class=\"token operator\">=</span>\n  <span class=\"token keyword\">typeof</span> navigator <span class=\"token operator\">!==</span> <span class=\"token string\">'undefined'</span> <span class=\"token operator\">&amp;&amp;</span>\n  navigator<span class=\"token punctuation\">.</span>scheduling <span class=\"token operator\">!==</span> <span class=\"token keyword\">undefined</span> <span class=\"token operator\">&amp;&amp;</span>\n  navigator<span class=\"token punctuation\">.</span>scheduling<span class=\"token punctuation\">.</span>isInputPending <span class=\"token operator\">!==</span> <span class=\"token keyword\">undefined</span>\n    <span class=\"token operator\">?</span> navigator<span class=\"token punctuation\">.</span>scheduling<span class=\"token punctuation\">.</span><span class=\"token function\">isInputPending</span><span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span>navigator<span class=\"token punctuation\">.</span>scheduling<span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">shouldYieldToHost</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token operator\">...</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>timeElapsed <span class=\"token operator\">&lt;</span> continuousInputInterval<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isInputPending <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token function\">isInputPending</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token operator\">...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>마지막으로 최대 간격 이내에 보류 중인 연속적이거나, 분리된 모든 이벤트에 대해\n양보합니다. 이후 모든 분기 처리가 담지 못한 케이스에 대해서는,\n보류 중인 입력이 없더라도 네트워크 이벤트와 같은 알지 못하는 다른 작업들이\n대기 중일 수 있다는 가정하에 무조건적으로 양보합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// SchedulerFeatureFlags.js</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> maxYieldMs <span class=\"token operator\">=</span> <span class=\"token number\">300</span><span class=\"token punctuation\">;</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> maxYieldMs <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'../SchedulerFeatureFlags'</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">shouldYieldToHost</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token operator\">...</span>\n    <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>timeElapsed <span class=\"token operator\">&lt;</span> maxInterval<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// Yield if there's either a pending discrete or continuous input.</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isInputPending <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">isInputPending</span><span class=\"token punctuation\">(</span>continuousOptions<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>초기에 분기처리 되었던 호스트 환경에 의존적인 isInputPending API를\n사용할 수 없는 경우 또한 무조건적으로 양보합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">shouldYieldToHost</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token operator\">...</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>enableIsInputPending<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token operator\">...</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>지금까지 알아본 <code class=\"language-text\">shouldYieldToHost()</code>는 스케쥴러의 <code class=\"language-text\">workLoop()</code>에서 사용됩니다. 현재 진행 중인 작업의 만료시간이 현재 시간에 비해 여유가 있는 시점에서\n우선 순위가 더 높은 작업이 보류되고 있다면, 메인 스레드에게 제어권을 양보하고, 만료 시간이\n지난 작업에 대해서는 양보하지 않고 동기적으로 바쁘게 작업을 이어나갑니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">workLoop</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">hasTimeRemaining<span class=\"token punctuation\">,</span> initialTime</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token operator\">...</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>\n    currentTask <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span>\n    <span class=\"token operator\">!</span><span class=\"token punctuation\">(</span>enableSchedulerDebugging <span class=\"token operator\">&amp;&amp;</span> isSchedulerPaused<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n      currentTask<span class=\"token punctuation\">.</span>expirationTime <span class=\"token operator\">></span> currentTime <span class=\"token operator\">&amp;&amp;</span>\n      <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>hasTimeRemaining <span class=\"token operator\">||</span> <span class=\"token function\">shouldYieldToHost</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token operator\">...</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>추가적으로 스케쥴러가 아닌, 동시성 모드에서 컴포넌트를 재조정하는 작업이 담긴\n<a href=\"https://github.com/facebook/react/blob/main/packages/react-reconciler/src/ReactFiberWorkLoop.new.js#L1836\">workLoopConcurrent</a>\n에서도 사용되는데요. shouldYield를 통해 진행되던 재조정 작업이\n중지될 수 있음이 조건에 담겨있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// react-reconciler/src/ReactFiberWorkLoop.new.js</span>\n\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> shouldYield <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./Scheduler'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">workLoopConcurrent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>workInProgress <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span><span class=\"token function\">shouldYield</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">performUnitOfWork</span><span class=\"token punctuation\">(</span>workInProgress<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이를 통해 리콘실러는 <code class=\"language-text\">workLoopConcurrent()</code>를 통해 현재 작업중이던 루트 혹은 Lane이\n변경되면, 루트에 대기중인 작업들을 모두 비우고, 변경된 레인의 작업이 진행될 수 있도록 합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">renderRootConcurrent</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token literal-property property\">root</span><span class=\"token operator\">:</span> FiberRoot<span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">lanes</span><span class=\"token operator\">:</span> Lanes</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> prevExecutionContext <span class=\"token operator\">=</span> executionContext<span class=\"token punctuation\">;</span>\n  executionContext <span class=\"token operator\">|=</span> RenderContext<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> prevDispatcher <span class=\"token operator\">=</span> <span class=\"token function\">pushDispatcher</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>workInProgressRoot <span class=\"token operator\">!==</span> root <span class=\"token operator\">||</span> workInProgressRootRenderLanes <span class=\"token operator\">!==</span> lanes<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token operator\">...</span>\n        <span class=\"token keyword\">const</span> memoizedUpdaters <span class=\"token operator\">=</span> root<span class=\"token punctuation\">.</span>memoizedUpdaters<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>memoizedUpdaters<span class=\"token punctuation\">.</span>size <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token function\">restorePendingUpdaters</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">,</span> workInProgressRootRenderLanes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          memoizedUpdaters<span class=\"token punctuation\">.</span><span class=\"token function\">clear</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token function\">movePendingFibersToMemoized</span><span class=\"token punctuation\">(</span>root<span class=\"token punctuation\">,</span> lanes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token operator\">...</span>\n\n  <span class=\"token keyword\">do</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">workLoopConcurrent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token operator\">...</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"reference\" style=\"position:relative;\"><a href=\"#reference\" aria-label=\"reference permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Reference</h2>\n<p><a href=\"https://deview.kr/2021/sessions/518\">Inside React (동시성을 구현하는 기술)</a></p>\n<p><a href=\"https://goidle.github.io/react/in-depth-react-preview/\">React 톺아보기 - 01. Preview</a></p>\n<p><a href=\"https://github.com/facebook/react/pull/18796\">github.com/facebook/react/pull/18796</a></p>\n<p><a href=\"https://github.com/facebook/react\">github.com/facebook/react</a></p>\n<p><a href=\"https://wicg.github.io/is-input-pending/#continuous-events\">wicg.github.io/is-input-pending</a></p>","frontmatter":{"title":"리엑트 동시성 매커니즘들은 어떻게 구현되어 있을 까 - 01","date":"June 11, 2022"}}},"pageContext":{"slug":"/react/react-concurrent-mode-01/","previous":{"fields":{"slug":"/web/stale-while-ravalidate/"},"frontmatter":{"title":"stale-while-revalidate 전략은 어떻게 활용되고 있을까"}},"next":{"fields":{"slug":"/typescript/typescript-essentials-you-should-know/"},"frontmatter":{"title":"타입스크립트, 글로 배웠습니다만"}}}},"staticQueryHashes":["2486386679","3128451518"]}