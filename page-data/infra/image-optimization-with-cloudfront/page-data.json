{"componentChunkName":"component---src-templates-blog-post-js","path":"/infra/image-optimization-with-cloudfront/","result":{"data":{"site":{"siteMetadata":{"title":"Youthfulhps.dev","description":"Blog posted front-end, troubleshooting!","author":"youthfulhps","siteUrl":"https://youthfulhps.dev","comment":{"disqusShortName":"youthfulhps","utterances":"youthfulhps/youthfulhps.github.io"},"sponsor":{"buyMeACoffeeId":"youthfulhps"}}},"markdownRemark":{"id":"6fec9e0f-716b-5900-a851-61b84725b5ca","excerpt":"사용자 경험 품질 향상을 위한 이미지 최적화에서 온디멘드 이미지 리사이징\n에 대한 이야기를 공유해드렸습니다. 이번 글에서는 CloudFront에서  를 통해 직접 구현해본 과정을 정리해보려 합니다. TL;DR S3 버킷을 생성하고 이미지를 업로드합니다. CloudFront를 통해 S3 컨텐츠를 배포합니다. 라시아징, webp 파일 형식 변환을 위한 노드 환경 람다 함수를 구현합니다. 버킷 접근 권한 및 역할을 담은 IAM을 정의하고 람다 함수에 부여합니다. CloudFront…","html":"<p><a href=\"https://youthfulhps.dev/web/image-optimization/\">사용자 경험 품질 향상을 위한 이미지 최적화</a>에서 온디멘드 이미지 리사이징\n에 대한 이야기를 공유해드렸습니다. 이번 글에서는 CloudFront에서 <code class=\"language-text\">lambda@edge</code> 를 통해 직접 구현해본 과정을 정리해보려 합니다.</p>\n<h2 id=\"tldr\" style=\"position:relative;\"><a href=\"#tldr\" aria-label=\"tldr permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>TL;DR</h2>\n<ol>\n<li>S3 버킷을 생성하고 이미지를 업로드합니다.</li>\n<li>CloudFront를 통해 S3 컨텐츠를 배포합니다.</li>\n<li>라시아징, webp 파일 형식 변환을 위한 노드 환경 람다 함수를 구현합니다.</li>\n<li>버킷 접근 권한 및 역할을 담은 IAM을 정의하고 람다 함수에 부여합니다.</li>\n<li>CloudFront의 오리진 응답 엣지에 람다 함수를 연동합니다.</li>\n</ol>\n<h2 id=\"s3-샘플-이미지-업로드\" style=\"position:relative;\"><a href=\"#s3-%EC%83%98%ED%94%8C-%EC%9D%B4%EB%AF%B8%EC%A7%80-%EC%97%85%EB%A1%9C%EB%93%9C\" aria-label=\"s3 샘플 이미지 업로드 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>S3, 샘플 이미지 업로드</h2>\n<p>일반적으로 사용되는 S3 버킷을 생성하는 과정과 동일합니다. <code class=\"language-text\">모든 퍼블릭 엑세스 차단이 비활성화</code> 가 선택된\n버킷을 생성하고 샘플 이미지 객체를 업로드해주세요.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1200px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 38.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABO0lEQVQoz5VRSXbDIBTz/e/Qy/QO7aJDbCdpGtsJmNEG7KqCDO910UUWeh/ERxKfqtkfsN3tULctscVu/4XhLKCNgdK61EdQ1fUGddNiU9fYNA3ePz7R0kQqxQZdRB9BJUfJhbkT2UUIgcxra/9Jwj59Mbxx5mpedX0P6xwJkhRQ1kPaCcrYO6fZaFmtdWVvnIeZU6n5TJM/aw/rJ1RCSozq4qSIkYIn7SDI3U146cS55uSH/gzRvGB8foLevsJOoQQSDGGnGZXhxk8eKUWESISAGEOpN0Ty83U9zQGzkZi/3xBYY1oQyS+8nzUqISSG0WL0oQimlApu6dZ15TxH9P1w4Yi0rFgApPWniExMNtMoj4WfotAMCnvp4HiQRWNMcEyex5DF85PzrI/HDseu42X2hfnPC5z3yOF+AbnoZN7grE7QAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"create s3 bucket\"\n        title=\"create s3 bucket\"\n        src=\"/static/886281b9a152864e2531ecdde013164a/c1b63/s3-bucket.png\"\n        srcset=\"/static/886281b9a152864e2531ecdde013164a/5a46d/s3-bucket.png 300w,\n/static/886281b9a152864e2531ecdde013164a/0a47e/s3-bucket.png 600w,\n/static/886281b9a152864e2531ecdde013164a/c1b63/s3-bucket.png 1200w,\n/static/886281b9a152864e2531ecdde013164a/9239a/s3-bucket.png 1246w\"\n        sizes=\"(max-width: 1200px) 100vw, 1200px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<h2 id=\"cloudfront-s3-컨텐츠-배포\" style=\"position:relative;\"><a href=\"#cloudfront-s3-%EC%BB%A8%ED%85%90%EC%B8%A0-%EB%B0%B0%ED%8F%AC\" aria-label=\"cloudfront s3 컨텐츠 배포 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>CloudFront, S3 컨텐츠 배포</h2>\n<p>CloudFront 배포를 생성합니다. 기본적으로 CloudFront는 쿼리 문자열을 무시하게 되는데,\n쿼리 문자열 파라미터 기반의 컨텐츠 캐싱이 가능하도록 <code class=\"language-text\">캐시 키 및 원본 요청</code>\n에서 <code class=\"language-text\">Lagacy cache settings</code> 를 선택하여 컨텐츠 캐싱에 사용할 <code class=\"language-text\">쿼리 문자열을 설정</code> 해줍니다.</p>\n<p>쿼리 문자열은 이미지 변환에 대한 설정을 전달하기 위한 역할로서\n<code class=\"language-text\">너비, 높이, 이미지 핏, webp 변환</code> 에 대한 설정값을 담을 수 있습니다.</p>\n<p>또한, <code class=\"language-text\">쿼리 문자열 파라미터 기반의 컨텐츠 캐싱</code> 이라는 특징에 따라, 동일한 쿼리 조합의 요청에 대한\n리사이징된 컨텐츠가 CloudFront에 캐싱되어 있다면, S3까지 오리진 요청이 전달되지 않고,\nCloudFront에서 뷰어 응답으로 빠르게 컨텐츠를 전달합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">https://...cloudfront/sample-image.jpg?w=500&amp;h=300</code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 646px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 82.66666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAAAsTAAALEwEAmpwYAAABrElEQVQ4y5VUaXeCMBDk//82X1/bD7ZVoJcWLwhHuNHtzkJ4YMVqfGMgWYaZ3Q3WfP5Cr28Lms0e6PHpmTxvQ8fjkaqqYtSCsmyvS15rmoYwTqeT4HxYB98nP1C02+1pf2ivtU4py3JKEk1RFFMYRpTw2sEPeNbXCfM8pziO+eGEibQ8rMKQ55CUUv19EASUZllPNjWsxZdHjm3T0nZosbQFAatUqiUNo0juQYiXD9WdQwiTNOMclVdtDMel/RFh+3ZFUZwI4gTQkyqmlBliC5a8zZbz0xYBydesuq5rqrmi/4LjEI/OEIUZisKqTDv0b+MfgpobgHbqLfvcCrbjkvvxyUkvxLbfpQCEd1tOWe73asVYk+O+C3SaUlGUt9nmGKSptwy5IG1PBoMDzEDQFIaWQdpbxiZOCVThiCGnOCUgv3eIZfyhKKg28qZCzLGcClHCtkbo1vKikOaHCKOuJyx4E4pGlvgh2J8C0rTZ7qSQw+YWQmwiwbiWQhhMFKKS3kvpx9sK4R+FaOjV2pOvjbEgSjFfQueg7lIwIkQADj0+TfhU1YMq31MMQ/oL16kym/3742QAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"cloudFront\"\n        title=\"cloudFront\"\n        src=\"/static/bb8a52f68069f6b1bb7de64e65c6a92a/27524/cloudFront.png\"\n        srcset=\"/static/bb8a52f68069f6b1bb7de64e65c6a92a/5a46d/cloudFront.png 300w,\n/static/bb8a52f68069f6b1bb7de64e65c6a92a/0a47e/cloudFront.png 600w,\n/static/bb8a52f68069f6b1bb7de64e65c6a92a/27524/cloudFront.png 646w\"\n        sizes=\"(max-width: 646px) 100vw, 646px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<h2 id=\"람다-함수에-부여할-iam-역할-생성\" style=\"position:relative;\"><a href=\"#%EB%9E%8C%EB%8B%A4-%ED%95%A8%EC%88%98%EC%97%90-%EB%B6%80%EC%97%AC%ED%95%A0-iam-%EC%97%AD%ED%95%A0-%EC%83%9D%EC%84%B1\" aria-label=\"람다 함수에 부여할 iam 역할 생성 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>람다 함수에 부여할 IAM 역할 생성</h2>\n<p>람다 함수에서 우리를 대신해 S3 객체에 접근할 수 있도록 <code class=\"language-text\">s3:GetObject</code> 와 같은 권한을 부여해주어야 합니다.\n<code class=\"language-text\">IAM 콘솔</code> 로 접근하여 역할을 생성, <code class=\"language-text\">AWS 서비스 / Lambda</code> 를 선택하고 단계를 넘어갑니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 981px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 42.33333333333334%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAAAsTAAALEwEAmpwYAAABIElEQVQoz41S7W6EIBD0/R+qfYm296+5qoUCiiLKh1/ThTsvl0vTdpMJiM7s7EgxDAM4Y+g6De8dYgjwzmHbNtzXvu8Zxz5V2Tg8vTa02xDnGcuyoDAkKGQDpXtwoTKaps0vE3El4XVdb4Kp0XY9u7a6PScULyzg+aTxdpY46wWfFlCdhZQCjJw7N2Ua5xxlWSLQBDHG3LCua1RVBSFEPsuCH2rEqTYoRY933qFUFoxcto2CGSz6kSKIC6ZpykjEJJoErbXU0GGmcQ+XxWgNWiXJAcM0jpTfhZg+dD5gDCvCvOKxjhzv803IGUqlEKjzz7Vfcroj/YaCqR6t7miUkEfx3uf1yOrRwZ+CX5oykx3sYJDcpmtkjMlrwvE3/yv4DVBfbnoVbMAfAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"create-iam\"\n        title=\"create-iam\"\n        src=\"/static/a30b87eaf5e4a000e4fe0cb332379170/1c3a5/create-iam.png\"\n        srcset=\"/static/a30b87eaf5e4a000e4fe0cb332379170/5a46d/create-iam.png 300w,\n/static/a30b87eaf5e4a000e4fe0cb332379170/0a47e/create-iam.png 600w,\n/static/a30b87eaf5e4a000e4fe0cb332379170/1c3a5/create-iam.png 981w\"\n        sizes=\"(max-width: 981px) 100vw, 981px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>다음 단계에서는 <code class=\"language-text\">정책 생성</code> 을 통해 JSON 편집을 통해 권한을 편집합니다.\n아래와 동일하게 작성하셔도 무방합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"Version\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2012-10-17\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"Statement\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"Sid\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"VisualEditor0\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"Effect\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Allow\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"Action\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token string\">\"iam:CreateServiceLinkedRole\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"lambda:GetFunction\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"lambda:EnableReplication\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"cloudfront:UpdateDistribution\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"s3:GetObject\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"logs:CreateLogGroup\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"logs:CreateLogStream\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"logs:PutLogEvents\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"logs:DescribeLogStreams\"</span>\n      <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"Resource\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"*\"</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">정책 이름</code> 을 설정하고, <code class=\"language-text\">정책 생성</code> 을 완료했다면, <code class=\"language-text\">IAM</code> 탭으로 돌아가\n람다 함수에게 실행 역할 즉, AWS 서비스 및 리소스에 접근할 수 있는 엑세스 권한을 <code class=\"language-text\">정책 연결</code>을 통해 제공합니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 985px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 24%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAjElEQVQY052OWw6CMBQFu3cX5Fr8M8FHgoW0hZZWgsW+jnJlAWCTyeT+TA8bbQ+lOjjniLZtMQwDpJR0L6+UshnGRYcHbyCEoMgS5JxTNISAnDNSSuQtsMPxglP9/O7IeK+BGCP9tncdLTxXd1TXG7TW0MaQzWrd6593wPxrQqMsamnhxgnz7OH9/3wAx1KCC2XdC/gAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"connect-policy\"\n        title=\"connect-policy\"\n        src=\"/static/f6d8a8940e62c5211434002e7fe55792/58bb7/connect-policy.png\"\n        srcset=\"/static/f6d8a8940e62c5211434002e7fe55792/5a46d/connect-policy.png 300w,\n/static/f6d8a8940e62c5211434002e7fe55792/0a47e/connect-policy.png 600w,\n/static/f6d8a8940e62c5211434002e7fe55792/58bb7/connect-policy.png 985w\"\n        sizes=\"(max-width: 985px) 100vw, 985px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p><code class=\"language-text\">역할 / 신뢰 관계 / 신례 관계 편집</code> 을 선택하여 마찬가지로 JSON 편집을 통해 역할에 신뢰 관계를 추가합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"Version\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2012-10-17\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"Statement\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n      <span class=\"token property\">\"Effect\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Allow\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"Principal\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"Service\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"edgelambda.amazonaws.com\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"lambda.amazonaws.com\"</span><span class=\"token punctuation\">]</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token property\">\"Action\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"sts:AssumeRole\"</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"온디멘드-이미지-webp-파일-형식-변환을-위한-lambda-함수-생성-w-sharpjs\" style=\"position:relative;\"><a href=\"#%EC%98%A8%EB%94%94%EB%A9%98%EB%93%9C-%EC%9D%B4%EB%AF%B8%EC%A7%80-webp-%ED%8C%8C%EC%9D%BC-%ED%98%95%EC%8B%9D-%EB%B3%80%ED%99%98%EC%9D%84-%EC%9C%84%ED%95%9C-lambda-%ED%95%A8%EC%88%98-%EC%83%9D%EC%84%B1-w-sharpjs\" aria-label=\"온디멘드 이미지 webp 파일 형식 변환을 위한 lambda 함수 생성 w sharpjs permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>온디멘드 이미지, WebP 파일 형식 변환을 위한 Lambda 함수 생성 (w/ sharp.js)</h2>\n<p>람다 함수를 생성합니다. 이때, 람다 트리거를 CloudFront로 설정할 수 있는 지역은\n<code class=\"language-text\">버지니아 북부</code> 만 가능하기 때문에 지역을 변경하고 람다 함수를 생성해주세요.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 978px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 51%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA40lEQVQoz6VS2Y6DMAzM///klq2qSrAkQE4SYNY20FZ9KW0tjZxL4/HEqmka1HWNaSoopSDn/BWUMR1M19GmIMZExBOWZcE8zx9BtVrj51Sh+j0LBmtRiJQvpw23NZ2/gur7Abq38CHAOQ9rHcZxlPb3R6ye85EghQbXukGIUZCIjLPzQYrshfjsiErykAn/ENMoymJKlLP4uINDfD0AdW07VOcLKctCmDZCbETvhuJP4Pae41HhEdwIeWTM4FYPQ7z75r0U4mydk8xjxX6ud3dwVzux4mFsWw1Nn8Pj8a6yZ/wDNRURG9YxeiMAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"create-lambda\"\n        title=\"create-lambda\"\n        src=\"/static/57e65d67c8b4ae261a794e50e8bb41a8/914c7/create-lambda.png\"\n        srcset=\"/static/57e65d67c8b4ae261a794e50e8bb41a8/5a46d/create-lambda.png 300w,\n/static/57e65d67c8b4ae261a794e50e8bb41a8/0a47e/create-lambda.png 600w,\n/static/57e65d67c8b4ae261a794e50e8bb41a8/914c7/create-lambda.png 978w\"\n        sizes=\"(max-width: 978px) 100vw, 978px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p><code class=\"language-text\">권한 / 구성</code> 탭에서 생성한 IAM 역할을 설정합니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 837px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 26.666666666666668%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAqElEQVQY042OyQrDMAxE/f/fmEJr6maxnX3xPpVd6KWQ9PBAMNLTMKU1VN9D1DWk0uBPgabroGqOpm1olqjbFv0wYJpnjNN0CtMky8vLun7Jh52U9ED9ZFeQcCxm5xystQVjDPbjQFXdwB8cIQR4yt0fMNUIHMbSkYfzHp7I0m3fqenyyWKC8QExJaQLmBJ32LwcQ2kSYizSLBTDime/4TXmeS8PS9sT3gNQgjcfQD13AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"set-policy\"\n        title=\"set-policy\"\n        src=\"/static/8eb26ebf210f9e4a278ce9a432ce7bc9/ddc81/set-policy.png\"\n        srcset=\"/static/8eb26ebf210f9e4a278ce9a432ce7bc9/5a46d/set-policy.png 300w,\n/static/8eb26ebf210f9e4a278ce9a432ce7bc9/0a47e/set-policy.png 600w,\n/static/8eb26ebf210f9e4a278ce9a432ce7bc9/ddc81/set-policy.png 837w\"\n        sizes=\"(max-width: 837px) 100vw, 837px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>이제, 람다 함수 대시보드로 이동하여 이미지 리사이징, webp 포맷팅 적용을 위한 코드를 업로드합니다.\n코드는 <a href=\"https://medium.com/daangn/lambda-edge%EB%A1%9C-%EA%B5%AC%ED%98%84%ED%95%98%EB%8A%94-on-the-fly-%EC%9D%B4%EB%AF%B8%EC%A7%80-%EB%A6%AC%EC%82%AC%EC%9D%B4%EC%A7%95-f4e5052d49f3\">AWS Lambda@Edge에서 실시간 이미지 리사이즈 &#x26; WebP 형식으로 변환</a>를 참고하고 약간의 수정을 더하여 작성하였는데, 위 글에서도 잘 정리되어 있지만, 구현하면서 짚고 넘어가야 될 부분들이 몇 가지 있었는데요.</p>\n<p><strong>노드 환경에서 동작하는 람다 머신이 별도로 가지고 있지 않은 모듈은 직접 <code class=\"language-text\">node_modules</code> 폴더를 함께 압축하여 제공해주어야 했습니다.</strong> 의존성 해결을 위한 별도의 설치 과정이 포함되어 있지 않습니다.\n<code class=\"language-text\">querystring</code>, <code class=\"language-text\">aws-sdk</code> 를 포함한 몇 가지 모듈들은 이미 의존성이 해결되어 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// Dependencies resolved</span>\n\n<span class=\"token keyword\">const</span> querystring <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'querystring'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">AWS</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'aws-sdk'</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p><strong>람다 함수에서 바디를 조작했다면, 그 결과가 1MB 이하여야 했습니다.</strong> 만약 1MB 보다 크다면, 이미지의 퀄리티를 단계적으로 낮추는 방법으로 접근했습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token constant\">MEGABYTE</span> <span class=\"token operator\">=</span> <span class=\"token number\">1046528</span>\n<span class=\"token keyword\">const</span> byteLength <span class=\"token operator\">=</span> Buffer<span class=\"token punctuation\">.</span><span class=\"token function\">byteLength</span><span class=\"token punctuation\">(</span>resizedImage<span class=\"token punctuation\">,</span> <span class=\"token string\">'base64'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>byteLength <span class=\"token operator\">></span> <span class=\"token constant\">MEGABYTE</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  resizedImage<span class=\"token punctuation\">.</span><span class=\"token function\">toFormat</span><span class=\"token punctuation\">(</span>requiredFormat<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">quality</span><span class=\"token operator\">:</span> <span class=\"token number\">90</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><strong>퀄리티 저하의 한계점을 넘어가거나, 타임 아웃이 되면 원본을 반환했습니다.</strong>\n1MB 제약을 지키기 위해서 변환 과정이 너무 오래 걸리거나, 이미지 퀄리티가\n너무 저하되는 경우 원본을 반환하도록 했습니다.</p>\n<p>이제 비즈니스에 맞게 코드를 수정하고, <code class=\"language-text\">node_modules</code> 와 함께 압축된 코드 업로드를 마치셨다면,\n람다 함수 상단 메뉴 <code class=\"language-text\">작업 / Lambda@edge 배포</code> 를 선택합니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 812px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 36.333333333333336%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAAA2UlEQVQoz5XRTW7CMBAFYJ+6t+qCm3RBq5RsGkQaxyEoJXEy47/HYIVFpSKopc9vNmNbY9U0DYriE2VZYppGBO/hHMP/4h5yzLDWQpELWFbk4yqs4tOu/Sw9qh4DPvSIXX3Etmrxvm9R1D12zQnbL50dfhjtnKBtEPFP31PAcZYDLTmczhaT5Lhwdp4pp4sACwrpMXmlk1TDMKCq9uj7HsYYmNZAa42u68BEeTb/WcrJJ7AMlaTxmreaiLEslOuU0l3xVscoGaGeufXeYbLBkgd1FabXF9DbBhcz6CBzqjHQjAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"upload-code\"\n        title=\"upload-code\"\n        src=\"/static/4156216eefefc2712ad4f0d24616971f/63ec5/upload-code.png\"\n        srcset=\"/static/4156216eefefc2712ad4f0d24616971f/5a46d/upload-code.png 300w,\n/static/4156216eefefc2712ad4f0d24616971f/0a47e/upload-code.png 600w,\n/static/4156216eefefc2712ad4f0d24616971f/63ec5/upload-code.png 812w\"\n        sizes=\"(max-width: 812px) 100vw, 812px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<p>CloudFront 이벤트는 <a href=\"https://youthfulhps.dev/web/image-optimization/#lambdaedge\">사용자 경험 품질 향상을 위한 이미지 최적화</a>에 기반하여 <code class=\"language-text\">오리진 응답</code> 을 설정합니다. 이제, 람다 함수를 <code class=\"language-text\">배포</code> 합니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 810px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 71.66666666666667%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAABeklEQVQ4y6VTi06DQBDkt/0r458YbavWUqutRV53vK9AGXcOMK2hiY9LJsDd7ezO7uDsdu+YzRe4u59hvniAUgpN0+BwOPwcdW2feV7A0TpBEIRI0xSnq+s6HI/HX8PZ+ArL5xVWrovtdgdWrLVG27b4y3J8qc5111ivX+yTZHmeW9ljpZcWz77D2e89UHYmJIQZelILrOyJoHFvKqEThBF0kqIyBlVlUFYVirK0xK30hNJ79O/sE5Px/iRhLFONoliqK5Bm2RcomcHtBfBskpDBlKyUtqMnETFWM0VU01ZS5SThhx9g8/qGIBTr2D4WSMRClvRM8gDZG5NODUamHODxaYm954EDimPVB0mwBYPH94HUGvmkwjPCUgaQJIm1C/8Sfv9nOalIjHWKvChRFL1cLQn45zAJk/WDi+w+FRBKzrKT/ofiFk7f8XUO14sRCSkJaWpawlgbVXaPVRP8LgeM5/Y+7WZqaZVIxj+XaTo08Rbl9RXM7Q0+AZ02RHec2QQWAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"distribution-lambda\"\n        title=\"distribution-lambda\"\n        src=\"/static/fb945c5c14381aae0d1b9ff3f6836096/d7542/distribution-lambda.png\"\n        srcset=\"/static/fb945c5c14381aae0d1b9ff3f6836096/5a46d/distribution-lambda.png 300w,\n/static/fb945c5c14381aae0d1b9ff3f6836096/0a47e/distribution-lambda.png 600w,\n/static/fb945c5c14381aae0d1b9ff3f6836096/d7542/distribution-lambda.png 810w\"\n        sizes=\"(max-width: 810px) 100vw, 810px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n    </span></p>\n<h2 id=\"마치면서\" style=\"position:relative;\"><a href=\"#%EB%A7%88%EC%B9%98%EB%A9%B4%EC%84%9C\" aria-label=\"마치면서 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>마치면서</h2>\n<p>단순히 코드 레벨과 물리적인 대응 방안을 고민하는 단계에서 더 넓은 접근 방식을 배울 수 있었던 좋은 경험이었습니다. 이미지 리사이징, webp 포맷팅이 잘 적용되는 지 확인해보실 수 있는 간단한 <a href=\"https://github.com/youthfulhps/image-ondemand-resizing\">프로젝트</a>를 구성해두었으니 경험해보실 수 있습니다.</p>\n<h2 id=\"reference\" style=\"position:relative;\"><a href=\"#reference\" aria-label=\"reference permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Reference</h2>\n<p><a href=\"https://medium.com/daangn/lambda-edge%EB%A1%9C-%EA%B5%AC%ED%98%84%ED%95%98%EB%8A%94-on-the-fly-%EC%9D%B4%EB%AF%B8%EC%A7%80-%EB%A6%AC%EC%82%AC%EC%9D%B4%EC%A7%95-f4e5052d49f3\">https://medium.com/daangn/lambda-edge로-구현하는-on-the-fly-이미지-리사이징-f4e5052d49f3</a></p>","frontmatter":{"title":"온디멘드 이미지 리사이징을 위한 인프라 구성","description":"모바일 환경이라면 이미지 사이즈를 줄여 보내주세요.","date":"May 31, 2022"}}},"pageContext":{"slug":"/infra/image-optimization-with-cloudfront/","previous":{"fields":{"slug":"/web/image-optimization/"},"frontmatter":{"title":"사용자 경험 품질 향상을 위한 이미지 최적화"}},"next":{"fields":{"slug":"/web/stale-while-ravalidate/"},"frontmatter":{"title":"stale-while-revalidate 전략은 어떻게 활용되고 있을까"}}}},"staticQueryHashes":["2486386679","3128451518"]}